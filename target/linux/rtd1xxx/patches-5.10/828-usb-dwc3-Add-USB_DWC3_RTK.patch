From f4df070081da446b6fc7c63c663f6ca19497d175 Mon Sep 17 00:00:00 2001
From: Ken Tseng <ken.tseng@realtek.com>
Date: Tue, 8 Mar 2022 14:41:48 +0800
Subject: [PATCH 47/54] 828: usb: dwc3: Add USB_DWC3_RTK

---
 drivers/usb/dwc3/Kconfig  |  2 +-
 drivers/usb/dwc3/Makefile |  5 +++
 drivers/usb/dwc3/core.c   | 82 +++++++++++++++++++++++++++++++++++++++
 drivers/usb/dwc3/core.h   | 32 ++++++++++++++-
 drivers/usb/dwc3/gadget.c | 15 +++++++
 drivers/usb/dwc3/host.c   |  4 ++
 6 files changed, 138 insertions(+), 2 deletions(-)

diff --git a/drivers/usb/dwc3/Kconfig b/drivers/usb/dwc3/Kconfig
index d16ff8320..f6f92b40c 100644
--- a/drivers/usb/dwc3/Kconfig
+++ b/drivers/usb/dwc3/Kconfig
@@ -73,7 +73,7 @@ config USB_DWC3_RTK_DUAL_ROLE
 	  say 'Y' or 'M' if you have such device.
 
 config USB_DWC3_RTK_TYPE_C
-	bool "RTK DWC3 Type C Driver (dynamical host/device mode switch)"
+	tristate "RTK DWC3 Type C Driver (dynamical host/device mode switch)"
 	default USB_DWC3_RTK if (USB_DWC3_DUAL_ROLE)
 	depends on USB_DWC3_DUAL_ROLE
 	help
diff --git a/drivers/usb/dwc3/Makefile b/drivers/usb/dwc3/Makefile
index ae86da0dc..7a8dc82cc 100644
--- a/drivers/usb/dwc3/Makefile
+++ b/drivers/usb/dwc3/Makefile
@@ -51,3 +51,8 @@ obj-$(CONFIG_USB_DWC3_MESON_G12A)	+= dwc3-meson-g12a.o
 obj-$(CONFIG_USB_DWC3_OF_SIMPLE)	+= dwc3-of-simple.o
 obj-$(CONFIG_USB_DWC3_ST)		+= dwc3-st.o
 obj-$(CONFIG_USB_DWC3_QCOM)		+= dwc3-qcom.o
+obj-$(CONFIG_USB_DWC3_RTK)		+= dwc3-rtk.o
+obj-$(CONFIG_USB_DWC3_RTK)		+= dwc3-rtk-debugfs.o
+obj-$(CONFIG_USB_DWC3_RTK_DUAL_ROLE)	+= dwc3-rtk-drd.o
+obj-$(CONFIG_USB_DWC3_RTK_TYPE_C)	+= dwc3-rtk-type_c.o
+obj-$(CONFIG_USB_TYPE_C_RTK_RTS5400) += rtk-rts5400.o
\ No newline at end of file
diff --git a/drivers/usb/dwc3/core.h b/drivers/usb/dwc3/core.h
index 79e1b82e5..bdc1eef67 100644
--- a/drivers/usb/dwc3/core.h
+++ b/drivers/usb/dwc3/core.h
@@ -200,6 +200,13 @@
 #define DWC3_EVENTQ		7
 #define DWC3_AUXEVENTQ		8
 
+#if 1 // USB_PATCH_BY_RTK
+/* Global TX Threshold Configuration Register */
+#define DWC3_GTXTHRCFG_MAXTXBURSTSIZE(n) (((n) & 0xff) << 16)
+#define DWC3_GTXTHRCFG_TXPKTCNT(n) (((n) & 0xf) << 24)
+#define DWC3_GTXTHRCFG_PKTCNTSEL BIT(29)
+#endif // USB_PATCH_BY_RTK
+
 /* Global RX Threshold Configuration Register */
 #define DWC3_GRXTHRCFG_MAXRXBURSTSIZE(n) (((n) & 0x1f) << 19)
 #define DWC3_GRXTHRCFG_RXPKTCNT(n) (((n) & 0xf) << 24)
@@ -253,8 +260,14 @@
 #define DWC3_GUCTL_HSTINAUTORETRY	BIT(14)
 
 /* Global User Control 1 Register */
+#if 1 // USB_PATCH_BY_RTK
+#define DWC3_GUCTL1_PARKMODE_DISABLE_HS	BIT(16)
+#endif // USB_PATCH_BY_RTK
 #define DWC3_GUCTL1_PARKMODE_DISABLE_SS	BIT(17)
 #define DWC3_GUCTL1_TX_IPGAP_LINECHECK_DIS	BIT(28)
+#if 1 // USB_PATCH_BY_RTK
+#define DWC3_GUCTL1_DEV_FORCE_20_CLK_FOR_30_CLK BIT(26)
+#endif // USB_PATCH_BY_RTK
 #define DWC3_GUCTL1_DEV_L1_EXIT_BY_HW	BIT(24)
 
 /* Global Status Register */
@@ -554,6 +567,10 @@
 #define DWC3_DEV_IMOD_INTERVAL_SHIFT	0
 #define DWC3_DEV_IMOD_INTERVAL_MASK	(0xffff << 0)
 
+#if 1 // USB_PATCH_BY_RTK
+#define DWC3_DEVICE_IMODI(n)		((0xffff & (n)))
+#endif // USB_PATCH_BY_RTK
+
 /* OTG Configuration Register */
 #define DWC3_OCFG_DISPWRCUTTOFF		BIT(5)
 #define DWC3_OCFG_HIBDISMASK		BIT(4)
@@ -1064,6 +1081,9 @@ struct dwc3_scratchpad_array {
  * @dis_split_quirk: set to disable split boundary.
  * @imod_interval: set the interrupt moderation interval in 250ns
  *			increments or 0 to disable.
+#if 1 // USB_PATCH_BY_RTK
+ * @fixed_dwc3_globals_regs_start: fix the dwc3 global register start address.
+#endif // USB_PATCH_BY_RTK
  */
 struct dwc3 {
 	struct work_struct	drd_work;
@@ -1252,6 +1272,10 @@ struct dwc3 {
 	unsigned		dis_u2_freeclk_exists_quirk:1;
 	unsigned		dis_del_phy_power_chg_quirk:1;
 	unsigned		dis_tx_ipgap_linecheck_quirk:1;
+#if 1 // USB_PATCH_BY_RTK
+	unsigned		dev_force_20_clk_for_30_clk:1;
+	unsigned		parkmode_disable_hs_quirk:1;
+#endif // USB_PATCH_BY_RTK
 	unsigned		parkmode_disable_ss_quirk:1;
 
 	unsigned		tx_de_emphasis_quirk:1;
@@ -1260,8 +1284,11 @@ struct dwc3 {
 	unsigned		dis_metastability_quirk:1;
 
 	unsigned		dis_split_quirk:1;
+	u16                     imod_interval;
 
-	u16			imod_interval;
+#if 1 // USB_PATCH_BY_RTK
+	u32			fixed_dwc3_globals_regs_start;
+#endif // USB_PATCH_BY_RTK
 };
 
 #define INCRX_BURST_MODE 0
@@ -1429,6 +1456,9 @@ struct dwc3_gadget_ep_cmd_params {
 void dwc3_set_prtcap(struct dwc3 *dwc, u32 mode);
 void dwc3_set_mode(struct dwc3 *dwc, u32 mode);
 u32 dwc3_core_fifo_space(struct dwc3_ep *dep, u8 type);
+#if 1 // USB_PATCH_BY_RTK
+int dwc3_core_soft_reset(struct dwc3 *dwc);
+#endif // USB_PATCH_BY_RTK
 
 #define DWC3_IP_IS(_ip)							\
 	(dwc->ip == _ip##_IP)
diff --git a/drivers/usb/dwc3/gadget.c b/drivers/usb/dwc3/gadget.c
index b68fe48ac..eba9aff94 100644
--- a/drivers/usb/dwc3/gadget.c
+++ b/drivers/usb/dwc3/gadget.c
@@ -2395,6 +2395,11 @@ static int dwc3_gadget_start(struct usb_gadget *g,
 	}
 
 	dwc->gadget_driver	= driver;
+
+#ifdef CONFIG_USB_PATCH_ON_RTK
+	dwc->link_state = 0;
+#endif // CONFIG_USB_PATCH_ON_RTK
+
 	spin_unlock_irqrestore(&dwc->lock, flags);
 
 	return 0;
@@ -2421,6 +2426,11 @@ static int dwc3_gadget_stop(struct usb_gadget *g)
 
 	spin_lock_irqsave(&dwc->lock, flags);
 	dwc->gadget_driver	= NULL;
+
+#ifdef CONFIG_USB_PATCH_ON_RTK
+	dwc->link_state = 0;
+#endif // CONFIG_USB_PATCH_ON_RTK
+
 	spin_unlock_irqrestore(&dwc->lock, flags);
 
 	free_irq(dwc->irq_gadget, dwc->ev_buf);
@@ -4001,6 +4011,9 @@ void dwc3_gadget_exit(struct dwc3 *dwc)
 		return;
 
 	usb_del_gadget(dwc->gadget);
+#if 1 // USB_PATCH_BY_RTK
+	dwc->gadget->udc = NULL;
+#endif // USB_PATCH_BY_RTK
 	dwc3_gadget_free_endpoints(dwc);
 	usb_put_gadget(dwc->gadget);
 	dma_free_coherent(dwc->sysdev, DWC3_BOUNCE_SIZE, dwc->bounce,
@@ -4011,6 +4024,10 @@ void dwc3_gadget_exit(struct dwc3 *dwc)
 	kfree(dwc->setup_buf);
 	dma_free_coherent(dwc->sysdev, sizeof(*dwc->ep0_trb) * 2,
 			  dwc->ep0_trb, dwc->ep0_trb_addr);
+
+#if 1 // USB_PATCH_BY_RTK
+	dwc->gadget = NULL;
+#endif // USB_PATCH_BY_RTK
 }
 
 int dwc3_gadget_suspend(struct dwc3 *dwc)
-- 
2.17.1

